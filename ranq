-- LocalScript in StarterPlayer -> StarterPlayerScripts
-- Universal Item Stealer - Steal items from other players

print("Universal Item Stealer Loading...")

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local backpack = player:WaitForChild("Backpack")
local char = player.Character or player.CharacterAdded:Wait()
local humanoid = char:WaitForChild("Humanoid")

-- Update character when respawned
player.CharacterAdded:Connect(function(newChar)
    char = newChar
    humanoid = newChar:WaitForChild("Humanoid")
    backpack = player:WaitForChild("Backpack") -- Update backpack reference too
    print("Character updated:", player.Name)
    print("Humanoid updated successfully")
end)

print("Player:", player.Name)
print("Services loaded successfully")

-- Data variables
local selectedPlayer = nil
local selectedTool = nil
local nearbyPlayers = {}

-- Create ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "UniversalItemStealer"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.Parent = playerGui

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 380, 0, 680)
mainFrame.Position = UDim2.new(0.5, -190, 0.5, -340)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Parent = screenGui

-- Add corner for beauty
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 8)
corner.Parent = mainFrame

-- Gradient Background
local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(35, 35, 40)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(25, 25, 30))
}
gradient.Rotation = 45
gradient.Parent = mainFrame

-- Enable Dragging
local dragging = false
local dragStart, startPos, dragInput

mainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or
       input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

mainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or
       input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input == dragInput then
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(
            startPos.X.Scale, startPos.X.Offset + delta.X,
            startPos.Y.Scale, startPos.Y.Offset + delta.Y
        )
    end
end)

-- Title Bar
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 40)
titleBar.Position = UDim2.new(0, 0, 0, 0)
titleBar.BackgroundColor3 = Color3.fromRGB(200, 70, 70)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 8)
titleCorner.Parent = titleBar

-- Title Text
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -40, 1, 0)
title.Position = UDim2.new(0, 8, 0, 0)
title.BackgroundTransparency = 1
title.Text = "Universal Item Stealer"
title.TextColor3 = Color3.new(1, 1, 1)
title.TextScaled = true
title.Font = Enum.Font.GothamBold
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = titleBar

-- Close Button
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 30, 0, 30)
closeBtn.Position = UDim2.new(1, -35, 0, 5)
closeBtn.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
closeBtn.Text = "ร—"
closeBtn.TextColor3 = Color3.new(1, 1, 1)
closeBtn.TextScaled = true
closeBtn.Font = Enum.Font.GothamBold
closeBtn.BorderSizePixel = 0
closeBtn.Parent = titleBar

local closeBtnCorner = Instance.new("UICorner")
closeBtnCorner.CornerRadius = UDim.new(0, 4)
closeBtnCorner.Parent = closeBtn

closeBtn.MouseButton1Click:Connect(function()
    screenGui:Destroy()
    print("GUI Closed")
end)

-- Scan Range Slider
local rangeLabel = Instance.new("TextLabel")
rangeLabel.Size = UDim2.new(1, -20, 0, 25)
rangeLabel.Position = UDim2.new(0, 10, 0, 50)
rangeLabel.BackgroundTransparency = 1
rangeLabel.Text = "Scan Range: 50 units"
rangeLabel.TextColor3 = Color3.new(1, 1, 1)
rangeLabel.TextScaled = true
rangeLabel.Font = Enum.Font.Gotham
rangeLabel.TextXAlignment = Enum.TextXAlignment.Left
rangeLabel.Parent = mainFrame

local rangeSlider = Instance.new("TextBox")
rangeSlider.Size = UDim2.new(1, -20, 0, 30)
rangeSlider.Position = UDim2.new(0, 10, 0, 75)
rangeSlider.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
rangeSlider.BorderSizePixel = 0
rangeSlider.PlaceholderText = "Scan range (10-200)"
rangeSlider.Text = "50"
rangeSlider.TextColor3 = Color3.new(1, 1, 1)
rangeSlider.TextScaled = true
rangeSlider.Font = Enum.Font.Gotham
rangeSlider.Parent = mainFrame

local rangeCorner = Instance.new("UICorner")
rangeCorner.CornerRadius = UDim.new(0, 6)
rangeCorner.Parent = rangeSlider

-- Item Search Box
local searchLabel = Instance.new("TextLabel")
searchLabel.Size = UDim2.new(1, -20, 0, 25)
searchLabel.Position = UDim2.new(0, 10, 0, 115)
searchLabel.BackgroundTransparency = 1
searchLabel.Text = "Search for Items:"
searchLabel.TextColor3 = Color3.new(1, 1, 1)
searchLabel.TextScaled = true
searchLabel.Font = Enum.Font.Gotham
searchLabel.TextXAlignment = Enum.TextXAlignment.Left
searchLabel.Parent = mainFrame

local searchBox = Instance.new("TextBox")
searchBox.Size = UDim2.new(1, -20, 0, 30)
searchBox.Position = UDim2.new(0, 10, 0, 140)
searchBox.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
searchBox.BorderSizePixel = 0
searchBox.PlaceholderText = "Type item name to search..."
searchBox.Text = ""
searchBox.TextColor3 = Color3.new(1, 1, 1)
searchBox.TextScaled = true
searchBox.Font = Enum.Font.Gotham
searchBox.Parent = mainFrame

local searchCorner = Instance.new("UICorner")
searchCorner.CornerRadius = UDim.new(0, 6)
searchCorner.Parent = searchBox

-- Scan Button
local scanBtn = Instance.new("TextButton")
scanBtn.Size = UDim2.new(1, -20, 0, 35)
scanBtn.Position = UDim2.new(0, 10, 0, 180)
scanBtn.BackgroundColor3 = Color3.fromRGB(70, 130, 200)
scanBtn.Text = "Scan for Players"
scanBtn.TextColor3 = Color3.new(1, 1, 1)
scanBtn.TextScaled = true
scanBtn.Font = Enum.Font.GothamSemibold
scanBtn.BorderSizePixel = 0
scanBtn.Parent = mainFrame

local scanCorner = Instance.new("UICorner")
scanCorner.CornerRadius = UDim.new(0, 6)
scanCorner.Parent = scanBtn

-- Players List Frame
local playersFrame = Instance.new("ScrollingFrame")
playersFrame.Size = UDim2.new(1, -20, 0, 120)
playersFrame.Position = UDim2.new(0, 10, 0, 225)
playersFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
playersFrame.BorderSizePixel = 0
playersFrame.ScrollBarThickness = 8
playersFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
playersFrame.Parent = mainFrame

local playersCorner = Instance.new("UICorner")
playersCorner.CornerRadius = UDim.new(0, 6)
playersCorner.Parent = playersFrame

local playersLayout = Instance.new("UIListLayout")
playersLayout.Parent = playersFrame
playersLayout.SortOrder = Enum.SortOrder.LayoutOrder
playersLayout.Padding = UDim.new(0, 3)

-- Items List Frame
local itemsFrame = Instance.new("ScrollingFrame")
itemsFrame.Size = UDim2.new(1, -20, 0, 120)
itemsFrame.Position = UDim2.new(0, 10, 0, 355)
itemsFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
itemsFrame.BorderSizePixel = 0
itemsFrame.ScrollBarThickness = 8
itemsFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
itemsFrame.Parent = mainFrame

local itemsCorner = Instance.new("UICorner")
itemsCorner.CornerRadius = UDim.new(0, 6)
itemsCorner.Parent = itemsFrame

local itemsLayout = Instance.new("UIListLayout")
itemsLayout.Parent = itemsFrame
itemsLayout.SortOrder = Enum.SortOrder.LayoutOrder
itemsLayout.Padding = UDim.new(0, 3)

-- Steal Button
local stealBtn = Instance.new("TextButton")
stealBtn.Size = UDim2.new(1, -20, 0, 40)
stealBtn.Position = UDim2.new(0, 10, 0, 485)
stealBtn.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
stealBtn.Text = "Steal Item"
stealBtn.TextColor3 = Color3.new(1, 1, 1)
stealBtn.TextScaled = true
stealBtn.Font = Enum.Font.GothamBold
stealBtn.BorderSizePixel = 0
stealBtn.Parent = mainFrame

local stealBtnCorner = Instance.new("UICorner")
stealBtnCorner.CornerRadius = UDim.new(0, 6)
stealBtnCorner.Parent = stealBtn

-- Steal All from Selected Player Button
local stealAllSelectedBtn = Instance.new("TextButton")
stealAllSelectedBtn.Size = UDim2.new(1, -20, 0, 40)
stealAllSelectedBtn.Position = UDim2.new(0, 10, 0, 535)
stealAllSelectedBtn.BackgroundColor3 = Color3.fromRGB(200, 120, 60)
stealAllSelectedBtn.Text = "Steal All Items from Selected Player"
stealAllSelectedBtn.TextColor3 = Color3.new(1, 1, 1)
stealAllSelectedBtn.TextScaled = true
stealAllSelectedBtn.Font = Enum.Font.GothamBold
stealAllSelectedBtn.BorderSizePixel = 0
stealAllSelectedBtn.Parent = mainFrame

local stealAllSelectedBtnCorner = Instance.new("UICorner")
stealAllSelectedBtnCorner.CornerRadius = UDim.new(0, 6)
stealAllSelectedBtnCorner.Parent = stealAllSelectedBtn

-- Steal All from Everyone Button
local stealAllBtn = Instance.new("TextButton")
stealAllBtn.Size = UDim2.new(1, -20, 0, 40)
stealAllBtn.Position = UDim2.new(0, 10, 0, 585)
stealAllBtn.BackgroundColor3 = Color3.fromRGB(150, 30, 150)
stealAllBtn.Text = "Steal All Items from Everyone"
stealAllBtn.TextColor3 = Color3.new(1, 1, 1)
stealAllBtn.TextScaled = true
stealAllBtn.Font = Enum.Font.GothamBold
stealAllBtn.BorderSizePixel = 0
stealAllBtn.Parent = mainFrame

local stealAllBtnCorner = Instance.new("UICorner")
stealAllBtnCorner.CornerRadius = UDim.new(0, 6)
stealAllBtnCorner.Parent = stealAllBtn

-- Feedback Label
local feedback = Instance.new("TextLabel")
feedback.Size = UDim2.new(1, -20, 0, 35)
feedback.Position = UDim2.new(0, 10, 0, 635)
feedback.BackgroundTransparency = 1
feedback.Text = "Click scan to find nearby players"
feedback.TextColor3 = Color3.fromRGB(255, 220, 100)
feedback.TextScaled = true
feedback.Font = Enum.Font.Gotham
feedback.TextWrapped = true
feedback.Parent = mainFrame

print("All UI elements created")

-- Distance calculation function
local function getDistance(pos1, pos2)
    return (pos1 - pos2).Magnitude
end

-- Scan nearby players function
local function scanNearbyPlayers()
    print("Scanning for players...")
    
    -- Update character reference
    char = player.Character
    
    -- Clear old list
    for _, child in ipairs(playersFrame:GetChildren()) do
        if child:IsA("TextButton") then 
            child:Destroy() 
        end
    end
    
    for _, child in ipairs(itemsFrame:GetChildren()) do
        if child:IsA("TextButton") then 
            child:Destroy() 
        end
    end
    
    nearbyPlayers = {}
    local scanRange = tonumber(rangeSlider.Text) or 50
    scanRange = math.clamp(scanRange, 10, 200)
    rangeLabel.Text = "Scan Range: " .. scanRange .. " units"
    
    if not char or not char:FindFirstChild("HumanoidRootPart") then
        feedback.Text = "Your character not found"
        return
    end
    
    local myPos = char.HumanoidRootPart.Position
    
    -- Find nearby players
    for _, otherPlayer in ipairs(Players:GetPlayers()) do
        if otherPlayer ~= player and otherPlayer.Character then
            local otherChar = otherPlayer.Character
            local otherRoot = otherChar:FindFirstChild("HumanoidRootPart")
            
            if otherRoot then
                local distance = getDistance(myPos, otherRoot.Position)
                
                if distance <= scanRange then
                    table.insert(nearbyPlayers, {
                        player = otherPlayer,
                        distance = distance,
                        character = otherChar
                    })
                end
            end
        end
    end
    
    print("Found nearby players:", #nearbyPlayers, "players")
    
    if #nearbyPlayers == 0 then
        feedback.Text = "No players found within " .. scanRange .. " units"
        return
    end
    
    -- Sort by distance
    table.sort(nearbyPlayers, function(a, b) return a.distance < b.distance end)
    
    -- Create buttons for each player
    for i, playerData in ipairs(nearbyPlayers) do
        local btn = Instance.new("TextButton")
        btn.Parent = playersFrame
        btn.LayoutOrder = i
        btn.Size = UDim2.new(1, -10, 0, 35)
        btn.Position = UDim2.new(0, 5, 0, 0)
        btn.Text = playerData.player.Name .. " (" .. math.floor(playerData.distance) .. "m)"
        btn.TextColor3 = Color3.new(1, 1, 1)
        btn.TextScaled = true
        btn.Font = Enum.Font.GothamSemibold
        btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        btn.BorderSizePixel = 0
        
        local btnCorner = Instance.new("UICorner")
        btnCorner.CornerRadius = UDim.new(0, 4)
        btnCorner.Parent = btn
        
        btn.MouseButton1Click:Connect(function()
            selectedPlayer = playerData
            print("Selected player:", playerData.player.Name)
            
            -- Reset all button colors
            for _, c in ipairs(playersFrame:GetChildren()) do
                if c:IsA("TextButton") then 
                    c.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
                end
            end
            
            -- Change selected button color
            btn.BackgroundColor3 = Color3.fromRGB(70, 130, 200)
            
            -- Show items of selected player
            showPlayerItems(playerData)
        end)
    end
    
    -- Update Canvas Size
    playersFrame.CanvasSize = UDim2.new(0, 0, 0, playersLayout.AbsoluteContentSize.Y + 10)
    feedback.Text = "Found players: " .. #nearbyPlayers .. " players"
end

-- Show player items function
local function showPlayerItems(playerData)
    print("Viewing items of:", playerData.player.Name)
    
    -- Update character reference to get latest data
    if playerData.player == player then
        playerData.character = player.Character
    end
    
    -- Clear old item list
    for _, child in ipairs(itemsFrame:GetChildren()) do
        if child:IsA("TextButton") then 
            child:Destroy() 
        end
    end
    
    local items = {}
    local searchTerm = searchBox.Text:lower()
    
    -- Find items from Backpack
    if playerData.player.Backpack then
        for _, tool in ipairs(playerData.player.Backpack:GetChildren()) do
            if tool:IsA("Tool") then
                local toolName = tool.Name:lower()
                if searchTerm == "" or toolName:find(searchTerm) then
                    table.insert(items, {tool = tool, location = "Backpack"})
                end
            end
        end
    end
    
    -- Find items being held - Update character reference
    local currentChar = playerData.player.Character
    if currentChar then
        for _, tool in ipairs(currentChar:GetChildren()) do
            if tool:IsA("Tool") then
                local toolName = tool.Name:lower()
                if searchTerm == "" or toolName:find(searchTerm) then
                    table.insert(items, {tool = tool, location = "Hand"})
                end
            end
        end
    end
    
    print("Found items of", playerData.player.Name .. ":", #items, "items")
    
    if #items == 0 then
        if searchTerm ~= "" then
            feedback.Text = "No items matching '" .. searchBox.Text .. "' found for " .. playerData.player.Name
        else
            feedback.Text = playerData.player.Name .. " has no items"
        end
        return
    end
    
    -- Create buttons for each item
    for i, itemData in ipairs(items) do
        local btn = Instance.new("TextButton")
        btn.Parent = itemsFrame
        btn.LayoutOrder = i
        btn.Size = UDim2.new(1, -10, 0, 35)
        btn.Position = UDim2.new(0, 5, 0, 0)
        btn.Text = itemData.tool.Name .. " (" .. itemData.location .. ")"
        btn.TextColor3 = Color3.new(1, 1, 1)
        btn.TextScaled = true
        btn.Font = Enum.Font.GothamSemibold
        btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        btn.BorderSizePixel = 0
        
        local btnCorner = Instance.new("UICorner")
        btnCorner.CornerRadius = UDim.new(0, 4)
        btnCorner.Parent = btn
        
        btn.MouseButton1Click:Connect(function()
            selectedTool = itemData
            print("Selected item:", itemData.tool.Name)
            
            -- Reset all button colors
            for _, c in ipairs(itemsFrame:GetChildren()) do
                if c:IsA("TextButton") then 
                    c.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
                end
            end
            
            -- Change selected button color
            btn.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
            feedback.Text = "Selected: " .. itemData.tool.Name .. " from " .. playerData.player.Name
        end)
    end
    
    -- Update Canvas Size
    itemsFrame.CanvasSize = UDim2.new(0, 0, 0, itemsLayout.AbsoluteContentSize.Y + 10)
    feedback.Text = playerData.player.Name .. " has items: " .. #items .. " items"
end

-- Search for specific item across all players
local function searchForItem()
    local searchTerm = searchBox.Text:lower()
    if searchTerm == "" then
        feedback.Text = "Please enter an item name to search"
        return
    end
    
    print("Searching for item:", searchBox.Text)
    
    -- Clear old lists
    for _, child in ipairs(playersFrame:GetChildren()) do
        if child:IsA("TextButton") then 
            child:Destroy() 
        end
    end
    
    for _, child in ipairs(itemsFrame:GetChildren()) do
        if child:IsA("TextButton") then 
            child:Destroy() 
        end
    end
    
    local foundItems = {}
    local scanRange = tonumber(rangeSlider.Text) or 50
    scanRange = math.clamp(scanRange, 10, 200)
    
    -- Update character reference
    char = player.Character
    
    if not char or not char:FindFirstChild("HumanoidRootPart") then
        feedback.Text = "Your character not found"
        return
    end
    
    local myPos = char.HumanoidRootPart.Position
    
    -- Search through all players
    for _, otherPlayer in ipairs(Players:GetPlayers()) do
        if otherPlayer.Character then
            local otherChar = otherPlayer.Character
            local otherRoot = otherChar:FindFirstChild("HumanoidRootPart")
            local distance = otherRoot and getDistance(myPos, otherRoot.Position) or math.huge
            
            -- Search in Backpack
            if otherPlayer.Backpack then
                for _, tool in ipairs(otherPlayer.Backpack:GetChildren()) do
                    if tool:IsA("Tool") then
                        local toolName = tool.Name:lower()
                        if toolName:find(searchTerm) then
                            table.insert(foundItems, {
                                tool = tool,
                                player = otherPlayer,
                                location = "Backpack",
                                distance = distance,
                                character = otherChar
                            })
                        end
                    end
                end
            end
            
            -- Search in Hand
            for _, tool in ipairs(otherChar:GetChildren()) do
                if tool:IsA("Tool") then
                    local toolName = tool.Name:lower()
                    if toolName:find(searchTerm) then
                        table.insert(foundItems, {
                            tool = tool,
                            player = otherPlayer,
                            location = "Hand",
                            distance = distance,
                            character = otherChar
                        })
                    end
                end
            end
        end
    end
    
    print("Found", #foundItems, "items matching:", searchBox.Text)
    
    if #foundItems == 0 then
        feedback.Text = "No items matching '" .. searchBox.Text .. "' found"
        return
    end
    
    -- Sort by distance
    table.sort(foundItems, function(a, b) return a.distance < b.distance end)
    
    -- Create buttons for found items
    for i, itemData in ipairs(foundItems) do
        local btn = Instance.new("TextButton")
        btn.Parent = itemsFrame
        btn.LayoutOrder = i
        btn.Size = UDim2.new(1, -10, 0, 35)
        btn.Position = UDim2.new(0, 5, 0, 0)
        
        local distanceText = itemData.distance < math.huge and (" [" .. math.floor(itemData.distance) .. "m]") or " [Far]"
        btn.Text = itemData.tool.Name .. " (" .. itemData.location .. ") - " .. itemData.player.Name .. distanceText
        btn.TextColor3 = Color3.new(1, 1, 1)
        btn.TextScaled = true
        btn.Font = Enum.Font.GothamSemibold
        btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        btn.BorderSizePixel = 0
        
        local btnCorner = Instance.new("UICorner")
        btnCorner.CornerRadius = UDim.new(0, 4)
        btnCorner.Parent = btn
        
        btn.MouseButton1Click:Connect(function()
            selectedTool = itemData
            selectedPlayer = {
                player = itemData.player,
                distance = itemData.distance,
                character = itemData.character
            }
            print("Selected item:", itemData.tool.Name, "from", itemData.player.Name)
            
            -- Reset all button colors
            for _, c in ipairs(itemsFrame:GetChildren()) do
                if c:IsA("TextButton") then 
                    c.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
                end
            end
            
            -- Change selected button color
            btn.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
            feedback.Text = "Selected: " .. itemData.tool.Name .. " from " .. itemData.player.Name
        end)
    end
    
    -- Update Canvas Size
    itemsFrame.CanvasSize = UDim2.new(0, 0, 0, itemsLayout.AbsoluteContentSize.Y + 10)
    feedback.Text = "Found " .. #foundItems .. " items matching '" .. searchBox.Text .. "'"
end

-- Steal item function
local function stealItem()
    print("Starting theft...")
    
    if not selectedPlayer then
        feedback.Text = "Please select a player first"
        return
    end
    
    if not selectedTool then
        feedback.Text = "Please select an item first"
        return
    end
    
    local targetTool = selectedTool.tool
    
    if not targetTool or not targetTool.Parent then
        feedback.Text = "Item is gone"
        return
    end
    
    print("Stealing:", targetTool.Name, "from", selectedPlayer.player.Name)
    
    -- Try stealing with different methods
    local success = false
    
    -- Method 1: Clone and move
    pcall(function()
        local clonedTool = targetTool:Clone()
        clonedTool.Parent = backpack
        success = true
        print("Successful theft using Clone method")
    end)
    
    -- Method 2: Direct parent change
    if not success then
        pcall(function()
            targetTool.Parent = backpack
            success = true
            print("Successful theft using Parent Change method")
        end)
    end
    
    -- Method 3: Use FireServer (for games with RemoteEvent)
    if not success then
        pcall(function()
            for _, obj in ipairs(game:GetDescendants()) do
                if obj:IsA("RemoteEvent") and obj.Name:lower():find("tool") or obj.Name:lower():find("item") then
                    obj:FireServer("give", targetTool.Name, player)
                    success = true
                    print("Request sent via RemoteEvent:", obj.Name)
                    break
                end
            end
        end)
    end
    
    if success then
        feedback.Text = ("Stole \"%s\" from %s successfully!"):format(targetTool.Name, selectedPlayer.player.Name)
        
        -- Force equip the stolen item to make it visible
        pcall(function()
            if humanoid and targetTool.Parent == backpack then
                humanoid:EquipTool(targetTool)
                print("Equipped stolen item:", targetTool.Name)
            end
        end)
        
        -- Auto update list
        task.wait(0.5)
        if selectedPlayer then
            showPlayerItems(selectedPlayer)
        end
    else
        feedback.Text = "Cannot steal - server has protection"
    end
end

-- Steal all items from selected player function
local function stealAllFromSelectedPlayer()
    if not selectedPlayer then
        feedback.Text = "Please select a player first"
        return
    end
    
    print("Starting theft from selected player:", selectedPlayer.player.Name)
    feedback.Text = "Stealing all items from " .. selectedPlayer.player.Name .. "..."
    
    local totalStolen = 0
    local targetPlayer = selectedPlayer.player
    
    -- Update character reference
    selectedPlayer.character = targetPlayer.Character
    
    -- Steal from Backpack
    if targetPlayer.Backpack then
        for _, tool in ipairs(targetPlayer.Backpack:GetChildren()) do
            if tool:IsA("Tool") then
                pcall(function()
                    local clonedTool = tool:Clone()
                    clonedTool.Parent = backpack
                    totalStolen = totalStolen + 1
                    print("Stole:", tool.Name, "from", targetPlayer.Name, "(Backpack)")
                end)
                
                -- Try direct move if clone failed
                if tool.Parent then
                    pcall(function()
                        tool.Parent = backpack
                        totalStolen = totalStolen + 1
                        print("Moved:", tool.Name, "from", targetPlayer.Name, "(Backpack)")
                    end)
                end
                
                task.wait(0.01) -- Small delay to prevent lag
            end
        end
    end
    
    -- Steal from Hand
    if selectedPlayer.character then
        for _, tool in ipairs(selectedPlayer.character:GetChildren()) do
            if tool:IsA("Tool") then
                pcall(function()
                    local clonedTool = tool:Clone()
                    clonedTool.Parent = backpack
                    totalStolen = totalStolen + 1
                    print("Stole:", tool.Name, "from", targetPlayer.Name, "(Hand)")
                end)
                
                -- Try direct move if clone failed
                if tool.Parent then
                    pcall(function()
                        tool.Parent = backpack
                        totalStolen = totalStolen + 1
                        print("Moved:", tool.Name, "from", targetPlayer.Name, "(Hand)")
                    end)
                end
                
                task.wait(0.01) -- Small delay to prevent lag
            end
        end
    end
    
    feedback.Text = ("Stole %d items from %s successfully!"):format(totalStolen, targetPlayer.Name)
    print("Theft from", targetPlayer.Name, "finished! Total items stolen:", totalStolen)
    
    -- Auto equip last stolen item to make it visible
    if totalStolen > 0 then
        pcall(function()
            for _, tool in ipairs(backpack:GetChildren()) do
                if tool:IsA("Tool") and humanoid then
                    humanoid:EquipTool(tool)
                    print("Equipped item:", tool.Name)
                    break
                end
            end
        end)
    end
    
    -- Auto update list
    task.wait(0.5)
    showPlayerItems(selectedPlayer)
end

-- Steal all items from everyone function
local function stealAllItems()
    print("Starting mass theft...")
    feedback.Text = "Stealing all items from everyone..."
    
    local totalStolen = 0
    local scanRange = tonumber(rangeSlider.Text) or 50
    scanRange = math.clamp(scanRange, 10, 200)
    
    -- Update character reference
    char = player.Character
    
    if not char or not char:FindFirstChild("HumanoidRootPart") then
        feedback.Text = "Your character not found"
        return
    end
    
    local myPos = char.HumanoidRootPart.Position
    
    -- Go through all players
    for _, otherPlayer in ipairs(Players:GetPlayers()) do
        if otherPlayer ~= player then
            local distance = math.huge
            
            -- Calculate distance if player has character
            if otherPlayer.Character and otherPlayer.Character:FindFirstChild("HumanoidRootPart") then
                distance = getDistance(myPos, otherPlayer.Character.HumanoidRootPart.Position)
            end
            
            -- Skip if too far (unless we want to steal from everyone regardless of distance)
            -- Comment out the next 3 lines if you want to steal from ALL players regardless of distance
            if distance > scanRange * 2 then -- Use 2x scan range for mass theft
                continue
            end
            
            -- Steal from Backpack
            if otherPlayer.Backpack then
                for _, tool in ipairs(otherPlayer.Backpack:GetChildren()) do
                    if tool:IsA("Tool") then
                        pcall(function()
                            local clonedTool = tool:Clone()
                            clonedTool.Parent = backpack
                            totalStolen = totalStolen + 1
                            print("Stole:", tool.Name, "from", otherPlayer.Name, "(Backpack)")
                        end)
                        
                        -- Try direct move if clone failed
                        if tool.Parent then
                            pcall(function()
                                tool.Parent = backpack
                                totalStolen = totalStolen + 1
                                print("Moved:", tool.Name, "from", otherPlayer.Name, "(Backpack)")
                            end)
                        end
                        
                        task.wait(0.01) -- Small delay to prevent lag
                    end
                end
            end
            
            -- Steal from Hand
            if otherPlayer.Character then
                for _, tool in ipairs(otherPlayer.Character:GetChildren()) do
                    if tool:IsA("Tool") then
                        pcall(function()
                            local clonedTool = tool:Clone()
                            clonedTool.Parent = backpack
                            totalStolen = totalStolen + 1
                            print("Stole:", tool.Name, "from", otherPlayer.Name, "(Hand)")
                        end)
                        
                        -- Try direct move if clone failed
                        if tool.Parent then
                            pcall(function()
                                tool.Parent = backpack
                                totalStolen = totalStolen + 1
                                print("Moved:", tool.Name, "from", otherPlayer.Name, "(Hand)")
                            end)
                        end
                        
                        task.wait(0.01) -- Small delay to prevent lag
                    end
                end
            end
        end
    end
    
    feedback.Text = ("Mass theft complete! Stole %d items total"):format(totalStolen)
    print("Mass theft finished! Total items stolen:", totalStolen)
    
    -- Auto equip last stolen item to make it visible
    if totalStolen > 0 then
        pcall(function()
            for _, tool in ipairs(backpack:GetChildren()) do
                if tool:IsA("Tool") and humanoid then
                    humanoid:EquipTool(tool)
                    print("Equipped item:", tool.Name)
                    break
                end
            end
        end)
    end
end

-- Connect events
scanBtn.MouseButton1Click:Connect(function()
    -- Button effect
    scanBtn.BackgroundColor3 = Color3.fromRGB(50, 100, 150)
    task.wait(0.1)
    scanBtn.BackgroundColor3 = Color3.fromRGB(70, 130, 200)
    
    scanNearbyPlayers()
end)

stealBtn.MouseButton1Click:Connect(function()
    -- Button effect
    stealBtn.BackgroundColor3 = Color3.fromRGB(180, 40, 40)
    task.wait(0.1)
    stealBtn.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
    
    stealItem()
end)

stealAllSelectedBtn.MouseButton1Click:Connect(function()
    -- Button effect
    stealAllSelectedBtn.BackgroundColor3 = Color3.fromRGB(160, 90, 40)
    task.wait(0.1)
    stealAllSelectedBtn.BackgroundColor3 = Color3.fromRGB(200, 120, 60)
    
    stealAllFromSelectedPlayer()
end)

stealAllBtn.MouseButton1Click:Connect(function()
    -- Button effect
    stealAllBtn.BackgroundColor3 = Color3.fromRGB(100, 20, 100)
    task.wait(0.1)
    stealAllBtn.BackgroundColor3 = Color3.fromRGB(150, 30, 150)
    
    stealAllItems()
end)

-- Search when typing in search box
searchBox.Changed:Connect(function(property)
    if property == "Text" then
        if searchBox.Text ~= "" then
            searchForItem()
        else
            -- Clear search results when search box is empty
            for _, child in ipairs(itemsFrame:GetChildren()) do
                if child:IsA("TextButton") then 
                    child:Destroy() 
                end
            end
            itemsFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
            feedback.Text = "Type item name to search across all players"
        end
    end
end)

-- Auto-search when Enter is pressed
searchBox.FocusLost:Connect(function(enterPressed)
    if enterPressed and searchBox.Text ~= "" then
        searchForItem()
    end
end)

-- Update character references manually (hotkey)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.R then
        -- Update all references when pressing R
        char = player.Character
        if char then
            humanoid = char:FindFirstChild("Humanoid")
            backpack = player:WaitForChild("Backpack")
            feedback.Text = "Character references updated! (Press R to refresh)"
            print("Manual character update completed")
        else
            feedback.Text = "Character not found!"
        end
    end
end)

-- Limit numbers in scan range box
rangeSlider.FocusLost:Connect(function()
    local num = tonumber(rangeSlider.Text)
    if not num or num < 10 then
        rangeSlider.Text = "10"
    elseif num > 200 then
        rangeSlider.Text = "200"
    else
        rangeSlider.Text = tostring(math.floor(num))
    end
    rangeLabel.Text = "Scan Range: " .. rangeSlider.Text .. " units"
end)

-- Auto update list every 5 seconds
spawn(function()
    while screenGui.Parent do
        task.wait(5)
        if selectedPlayer and selectedPlayer.player.Parent then
            -- Update character references
            char = player.Character
            selectedPlayer.character = selectedPlayer.player.Character
            
            -- Check if player is still in range
            if char and char:FindFirstChild("HumanoidRootPart") and 
               selectedPlayer.character and selectedPlayer.character:FindFirstChild("HumanoidRootPart") then
                local distance = getDistance(char.HumanoidRootPart.Position, selectedPlayer.character.HumanoidRootPart.Position)
                selectedPlayer.distance = distance
                
                local scanRange = tonumber(rangeSlider.Text) or 50
                if distance <= scanRange then
                    showPlayerItems(selectedPlayer)
                else
                    feedback.Text = selectedPlayer.player.Name .. " is too far away"
                end
            end
        end
    end
end)

print("Universal Item Stealer ready!")
print("Warning: Use only on test servers")
print("How to use:")
print("- Scan for players -> Select player -> Select item -> Steal")
print("- OR type item name to search -> Select item -> Steal") 
print("- OR select player -> click 'Steal All Items from Selected Player'")
print("- OR click 'Steal All Items from Everyone' for mass theft")
print("- Press R key to refresh character if items don't show properly")
